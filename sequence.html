<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <title>Sequence</title>
    <link rel="stylesheet" href="styles/components.css">
    <style media="screen">
      .small {
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div class="progressbarback"></div>
    <div class="progressbar"></div>
    <a class="btn" href="index.html">&lt;</a>
    <div class="container">
      <button type="button" class="btn restart">restart</button>
      <div class="jumbotron" id="question"></div>
      <input type="text" placeholder="answer" id="answer">
      <div id="feedback"></div>
    </div>
  </body>
  <script type="text/javascript">
    var count = 0;
    var score = 0;
    var maxQ = 5;
    var seqMaxN = 5;
    var seq;
    var explainArray = [];

    // return random integer between low and high (inclusive)
    function random(low,high) { return Math.floor((Math.random() * (high-low+1)) + low); }

    // 1 or -1
    function pm() {
      if (Math.random() > 0.5) return 1;
      return -1;
    }

    // format 2 -> +2
    function pSign(a) {
      if (a>0) return '+ ' + a;
      return '- ' + (-a);
    }

    // format -2 -> (-2)
    function mBracket(a) {
      if (a<0) return '(' + a + ')';
      return a;
    }

    $('.btn').click(function() {
      if ($(this).hasClass('restart')) {
        restart();
        ans = newQ();
      }
    })

    // gen sequence
    function genSeq(mode) {
      var a = random(1,5) * pm();
      switch (mode) {
        case 1: // arithmetic
          for (var i=0; i<seqMaxN; i++) seq.push(seq[seq.length-1]+a);
          return [mode, a];
          break;
        case 2: // geometric
          for (var i=0; i<seqMaxN; i++) seq.push(seq[seq.length-1]*a);
          return [mode, a];
          break;
        case 3: // geometric then arithmetic
          var b = random(-1,4) * pm();
          for (var i=0; i<seqMaxN; i++) seq.push(seq[seq.length-1]*a+b);
          return [mode, a, b];
          break;
        case 4: // fibonacci
          seq.push(seq[seq.length-1]);
          for (var i=1; i<seqMaxN; i++) seq.push(seq[seq.length-1] + seq[seq.length-2]);
          return [mode, 'Fibonacci'];
          break;
        default:
      }
    }

    function seqString() {
      var s = "";
      for (var i=0; i<seqMaxN; i++) s = s + seq[i] + ", ";
      return s;
    }

    // new question
    function newQ() {
      var mode = random(1,4);
      seq = [random(-10,10)];
      explainArray = genSeq(mode);
      $('#question').text(seqString() + "___");
      return seq[seq.length-1];
    }

    // explain answer
    function explain() {
      switch (explainArray[0]) {
        case 1:
          return "x(n+1) = x(n) " + pSign(explainArray[1]);
          break;
        case 2:
          return "x(n+1) = x(n) × " + mBracket(explainArray[1]);
          break;
        case 3:
          return "x(n+1) = x(n) × " + mBracket(explainArray[1]) + " " + pSign(explainArray[2]);
          break;
        case 4:
          return "Fibonacci";
          break;
        default:
      }
    }

    var ans = newQ();

    $('#answer').keyup(function(event) {
      if (event.keyCode == 13 && ($('#answer').val() != '' || count == maxQ)) {
        count++;
        $('.progressbar').css('width',count/maxQ*100 + '%');
        var answerInput = $('#answer').val();
        if (answerInput == ans) {
          score++;
          $('#feedback').append(seqString() + '<strong>' + ans + '</strong>' + ' <span style="color:#0a8">✓</span><br>')
        } else {
          $('#feedback').append(seqString() + '<strong>' + ans + '</strong>' + ' ≠ ' + answerInput +' <span style="color:#f65; font-weight: bold">✕</span><br>')
          $('#feedback').append('<span class="small">' + explain() + '</span> <span style="color:#fff; font-weight: bold">✕</span><br><br>')
        }
        $('#answer').val('');
        if (count < maxQ) {
          ans = newQ();
        } else if (count == maxQ){
          showResult();
          $('#answer').attr('placeholder', 'press [enter] to restart');
          $('#answer').val('');
        } else {
          restart();
          ans = newQ();
        }
      }
    })

    // show result
    function showResult() { $('#question').text('score: ' + score + '/' + maxQ); }

    // restart
    function restart() {
      count = 0;
      score = 0;
      $('#feedback').text('');
      $('#answer').attr('placeholder', 'answer');
      $('.progressbar').css('width',0);
      $('#answer').focus();
    }

  </script>
</html>
